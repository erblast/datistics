---
title: Easyalluvial 0.2.0 released
author: Björn Koneswarakantha
date: '2019-04-01'
slug: easyalluvial-0-2-0-released
categories:
  - R
  - visualisation
tags:
  - R
  - visualisation
  - easyalluvial
keywords:
  - tech
summary: Mayor Release for easyalluvial with exciting new features. Visualise model response using 4 dimensional partial dependence plots and add marginal histograms to visualise distribution of binned numerical values.
thumbnailImagePosition : left
thumbnailImage: easyalluvial_logo.png
editor_options: 
  chunk_output_type: console
output:
  blogdown::html_page
---



<p><code>easyalluvial</code> allows you to build exploratory alluvial plots (sankey diagrams) with a single line of code while automatically binning numerical variables. In version <code>0.2.0</code> marginal histograms improve the visibility of those numerical variables. Further a method has been added that creates model agnostic 4 dimensional partial dependence alluvial plots to visualise the response of statistical models.</p>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>I am happy to announce the release of <code>easyalluvial 0.2.0</code> with some exciting new features and some minor changes compared to version <code>0.1.8</code> Some improvements were made on the default plotting options with improved colors and label size.</p>
<pre class="r"><code>suppressPackageStartupMessages( require(tidyverse) )
suppressPackageStartupMessages( require(easyalluvial) )</code></pre>
</div>
<div id="marginal-histograms" class="section level1">
<h1>Marginal Histograms</h1>
<p>The automated binning of numerical variables hides their distribution. This new feature alleviates that.</p>
<pre class="r"><code>p = alluvial_wide(mtcars2, max_variables = 9)

p_grid = add_marginal_histograms(p, mtcars2)</code></pre>
<p><img src="/post/2019-04-01-easyalluvial-0-2-0-released_files/figure-html/unnamed-chunk-2-1.png" width="960" /></p>
</div>
<div id="partial-dependence-alluvial-plots-with-4-dimensions" class="section level1">
<h1>Partial Dependence Alluvial Plots with 4 dimensions</h1>
<p>Alluvial plots are capable of displaying higher dimensional data on a plane, thus lend themselves to plot the response of a statistical model to changes in the input data across multiple dimensions. The practical limit here is 4 dimensions while conventional partial dependence plots are limited to 2 dimensions.</p>
<p>Briefly the 4 variables with the highest feature importance for a given model are selected and 5 values spread over the variable range are selected for each. Then a grid of all possible combinations is created. All none-plotted variables are set to the values found in the first row of the training data set. Using this artificial data space model predictions are being generated. This process is then repeated for each row in the training data set and the overall model response is averaged in the end. Each of the possible combinations is plotted as a flow which is coloured by the bin corresponding to the average model response generated by that particular combination.</p>
<p><a href="https://christophm.github.io/interpretable-ml-book/">more on partial dependence plots (ebook)</a></p>
<pre class="r"><code>df = select(mtcars2, -ids)

train = caret::train( disp ~ .
                      ,  df
                      , method = &#39;rf&#39;
                      , trControl = caret::trainControl( method = &#39;none&#39; )
                      , importance = TRUE )


p = alluvial_model_response_caret(train, degree = 4, method = &#39;pdp&#39;)</code></pre>
<pre><code>## [======================================================&gt;----------------] 78%
## [=========================================================&gt;-------------] 81%
## [===========================================================&gt;-----------] 84%
## [=============================================================&gt;---------] 88%
## [===============================================================&gt;-------] 91%
## [==================================================================&gt;----] 94%
## [====================================================================&gt;--] 97%
## [=======================================================================] 100%</code></pre>
<pre class="r"><code>p_grid = add_marginal_histograms(p, df, plot = F) %&gt;%
  add_imp_plot(p, df)</code></pre>
<p><img src="/post/2019-04-01-easyalluvial-0-2-0-released_files/figure-html/unnamed-chunk-3-1.png" width="1152" /></p>
<p>We see that the top 4 important features of the model have been selected and that 5 values have been picked over the range of the numerical variables which together with the levels of the categorical variable have been used to construct a data grid of all possible combinations.</p>
<div id="step-by-step" class="section level4">
<h4>Step-by-Step</h4>
<ul>
<li>On the left we see the averaged model predictions that are generated by a specific combination of the 4 most important variables. You can find the combinations by tracing the coloured flows.</li>
<li>The stratum label of the individual feature variables indicate the variable value and which fraction of the colored flows pass through it.</li>
<li>On the right you see the feature importance of all variables and the proportion contributed by the plotted variables on the alluvial plot.</li>
<li>On the top left you see how the distribution of the generated predictions compare to the distribution of the predicted variable (in this case disp) in the training data.</li>
<li>The marginal histograms indicate the original distributions in the raining data and the lines indicate the location of the values picked for the data grid.</li>
</ul>
<p>A more in-depth tutorial for this feature can be found on the <a href="https://github.com/erblast/easyalluvial">project’s github page</a> which will also be vailable on this blog in a few days.</p>
<p>If you are as enthusiastic about alluvial plots as me you will appreciate partial dependency alluvial plots because they can help us to get an immediate intuitive understanding how predictions of a certain range can be generated by the model. They can be understood by none-statistical stakeholders and invite the viewer to start exploring and question the decision making process of the model while also conveying an appreciation for the model complexity as flows branch out to the variables of lower feature importance. Ther are limitations though.</p>
</div>
<div id="limitations" class="section level4">
<h4>Limitations</h4>
<ul>
<li>There is a loss of information when binning the numerical variables</li>
<li>The combinations generated when making the grid might be outside the feature distribution space (generate combinations that are impossible)</li>
<li>We only look at the combination of 4 features and disregard the others</li>
<li>For a better interpretability of the feature importance it is adivable to remove strongly correlating variables and to scale, center and transform (Yeo-Johnson, Box-Cox) numerical variables, depending on the statistical model.</li>
</ul>
<p>To alleviate this you can reduce the complexity of the model by reducing features (take out correlating variables) or use additional model exploration methods such as classical PDPs, ALE plots, Shapely values, etc, …</p>
</div>
<div id="we-do-not-have-to-use-caret" class="section level4">
<h4>We do not have to use <code>caret</code></h4>
<p><em>Note: importance is calculated differently when using this implementation of random forest.</em></p>
<pre class="r"><code>df = select(mtcars2, -ids)
m = randomForest::randomForest( disp ~ ., df)
imp = m$importance

dspace = get_data_space(df, imp, degree = 4)

pred = get_pdp_predictions(df, imp
                           , m
                           , degree = 4
                           , bins = 5)


p = alluvial_model_response(pred, dspace, imp, degree = 4, method = &#39;pdp&#39;)

p_grid = add_marginal_histograms(p, df, plot = F) %&gt;%
  add_imp_plot(p, df)</code></pre>
</div>
</div>
<div id="changes-in-default-plotting-settings" class="section level1">
<h1>Changes in Default Plotting Settings</h1>
<ul>
<li><p>Default colors have been changed. The first 7 colors of <code>palette_qualitative()</code> the function that provides the default colors have hand-picked for better contrast.</p></li>
<li><p>The stratum fill color of the variable determining the flow fill color in <code>alluvial_wide()</code> hast been set to match the flow fill color.</p></li>
<li><p>label text size can now be modified via <code>stratum_label_size</code> parameter. Labels have gotten slightly bigger by default.</p></li>
</ul>
</div>
<div id="more-changes" class="section level1">
<h1>More changes</h1>
<p>… <a href="https://github.com/erblast/easyalluvial/blob/master/NEWS.md">NEWS.md</a></p>
</div>
